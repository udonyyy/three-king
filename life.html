<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
  />
  <title>ç”Ÿæ´»åˆ†äº«âœ¨ - Three KING</title>
  <link rel="icon" href="atm.jpg" type="image/png/jpg">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3b82f6',
            secondary: '#10b981',
            neutral: '#f3f4f6',
          },
          boxShadow: {
            card: '0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.03)',
            'card-hover': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      },
    };
  </script>

  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto { content-visibility: auto; }
      .text-balance { text-wrap: balance; }
      .nav-item {
        @apply relative px-4 py-2 text-gray-600 hover:text-primary transition-colors duration-200;
      }
      .nav-item.active {
        @apply text-primary font-medium;
      }
      .nav-item.active::after {
        @apply content-[''] absolute bottom-0 left-1/2 transform -translate-x-1/2 w-2 h-2 rounded-full bg-primary;
      }
      .page-btn {
        @apply w-9 h-9 flex items-center justify-center rounded-md border border-gray-200 hover:border-primary hover:text-primary transition-all;
      }
      .page-btn.active {
        @apply bg-primary text-white border-primary;
      }
      .page-btn:disabled {
        @apply opacity-50 cursor-not-allowed hover:border-gray-200 hover:text-gray-500;
      }
    }

    body { @apply font-inter bg-gray-50 text-gray-800; }
    .filter-tag {
      @apply bg-white text-gray-700 px-3 py-1.5 text-sm rounded-full cursor-pointer transition-all hover:bg-gray-100 shadow-sm;
    }
    .filter-tag.active { @apply bg-primary text-white shadow-none; }
    .tag {
      @apply bg-white text-gray-700 px-3 py-1.5 text-sm rounded-full cursor-pointer transition-all hover:bg-gray-100 shadow-sm;
    }
    .tag.active { @apply bg-primary text-white shadow-none; }

    .emoji-picker {
      @apply grid grid-cols-7 gap-2 mt-2 max-h-40 overflow-y-auto p-2 border border-gray-200 rounded-lg bg-white shadow-sm;
    }
    .emoji-item { @apply text-xl cursor-pointer p-2 rounded transition-all hover:bg-gray-100 hover:scale-110; }
    .selected-emoji { @apply text-xl relative p-1; }
    .remove-emoji {
      @apply absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center cursor-pointer;
    }

    .empty-state { @apply text-center py-16 text-gray-500; }
    .diary-card {
      @apply bg-white rounded-xl shadow-card p-6 transition-all duration-300 hover:shadow-card-hover hover:-translate-y-1;
    }
    .file-preview { @apply flex items-center gap-2 p-3 bg-gray-50 rounded-lg mb-3; }
    .file-icon { @apply bg-gray-100 p-2 rounded; }

    .comment-actions { @apply flex justify-end gap-3 mt-1 text-xs; }
    .comment-actions button {
      @apply transition-colors; /* ç§»é™¤ä¸‹åˆ’çº¿ */
    }
    .comment-actions button:first-child { @apply text-primary hover:text-primary/80; }
    .comment-actions button:last-child { @apply text-red-500 hover:text-red-600; }
  </style>
</head>

<body>
  <!-- å¯¼èˆªæ ï¼ˆå››é¡¹å±…ä¸­ï¼‰ -->
  <header class="bg-white shadow-sm sticky top-0 z-40">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <!-- å·¦ä¾§Logo -->
      <a href="index.html" class="flex items-center gap-2">
          <i class="fa fa-paper-plane text-primary text-2xl"></i>
          <h1 class="text-xl font-bold text-primary">Three King</h1>
        </a>

      <!-- ä¸­é—´å¯¼èˆªï¼ˆå››é¡¹å±…ä¸­ï¼‰ -->
      <nav class="hidden md:flex items-center justify-center flex-1">
        
        <a href="study.html" class="nav-item" data-nav="study">
          <i class="fas fa-book mr-1"></i> å­¦ä¹ ç¢ç‰‡
        </a>
        <a href="#" class="nav-item active" data-nav="life">
          <i class="fas fa-smile mr-1"></i> ç”Ÿæ´»åˆ†äº«
        </a>
        <a href="contact.html" class="nav-item" data-nav="contact">
          <i class="fas fa-envelope mr-1"></i> è”ç³»æ–¹å¼
        </a>
      </nav>

      <!-- å³ä¾§ç§»åŠ¨ç«¯æŒ‰é’® -->
      <button class="md:hidden text-gray-600 hover:text-primary" id="mobileMenuBtn">
        <i class="fas fa-bars text-xl"></i>
      </button>
    </div>

    <!-- ç§»åŠ¨ç«¯å¯¼èˆªèœå• -->
    <div class="md:hidden hidden mt-3 pb-2 border-t border-gray-100" id="mobileMenu">
      <a href="index.html" class="block py-2 text-gray-600 hover:text-primary px-4">
        <i class="fas fa-home mr-1"></i> é¦–é¡µ
      </a>
      <a href="study.html" class="block py-2 text-gray-600 hover:text-primary px-4">
        <i class="fas fa-book mr-1"></i> å­¦ä¹ ç¢ç‰‡
      </a>
      <a href="#" class="block py-2 text-primary font-medium px-4">
        <i class="fas fa-smile mr-1"></i> ç”Ÿæ´»åˆ†äº«
      </a>
      <a href="contact.html" class="block py-2 text-gray-600 hover:text-primary px-4">
        <i class="fas fa-envelope mr-1"></i> è”ç³»æ–¹å¼
      </a>
    </div>
  </header>

  <!-- ä¸»å†…å®¹åŒº -->
  <main class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- æœç´¢ + è¿‡æ»¤æ  -->
    <div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-8">
      <!-- æœç´¢æ¡†ï¼ˆç§»é™¤é—®å·ï¼Œæ¢å¤æœç´¢å›¾æ ‡ï¼‰ -->
      <div class="relative w-full md:w-1/2">
        <input
          type="text"
          id="searchInput"
          placeholder="æœç´¢è®°å½•..."
          class="w-full px-10 py-2.5 rounded-full border border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all shadow-sm"
        />
        <i class="fas fa-search text-gray-400 absolute left-4 top-1/2 transform -translate-y-1/2"></i>
        <button
          id="searchBtn"
          class="absolute right-2 top-1/2 transform -translate-y-1/2 px-3 py-1.5 bg-primary text-white rounded-full hover:bg-primary/90 transition-all text-sm font-medium"
        >
          <i class="fas fa-search mr-1"></i> æœç´¢
        </button>
      </div>

      <!-- è¿‡æ»¤æ ‡ç­¾ï¼ˆè‡ªå®šä¹‰æ ‡ç­¾ä¸å…¶ä»–æ ‡ç­¾å¹¶è¡Œï¼‰ -->
      <div class="flex flex-wrap gap-2">
        <div class="filter-tag active" data-tag="all">å…¨éƒ¨</div>
        <div class="filter-tag" data-tag="æ—¥å¸¸">æ—¥å¸¸</div>
        <div class="filter-tag" data-tag="ç¾é£Ÿ">ç¾é£Ÿ</div>
        <div class="filter-tag" data-tag="æ—…è¡Œ">æ—…è¡Œ</div>
        <div class="filter-tag" data-tag="æ„Ÿæ‚Ÿ">æ„Ÿæ‚Ÿ</div>
        <div class="filter-tag" data-tag="å…¶ä»–">å…¶ä»–</div>
        <div class="filter-tag" data-tag="custom">è‡ªå®šä¹‰</div> <!-- è‡ªå®šä¹‰æ ‡ç­¾ç­›é€‰ -->
      </div>
    </div>

    <!-- å‘å¸ƒè¡¨å• -->
    <form class="bg-white rounded-xl shadow-card p-6 mb-8 transition-all hover:shadow-md">
      <h2 class="text-xl font-semibold text-primary mb-5 flex items-center gap-2">
        <i class="fas fa-pen"></i> åˆ†äº«ä½ çš„ç”Ÿæ´»è¶£äº‹
      </h2>

      <!-- è¡Œ1ï¼šæ˜µç§° + Emoji é€‰æ‹© -->
      <div class="space-y-5 mb-5">
        <!-- æ˜µç§° -->
        <div class="w-full">
          <label for="authorInput" class="block text-sm font-medium mb-1.5 text-gray-700">ä½ çš„æ˜µç§°ï¼ˆå¯é€‰ï¼‰</label>
          <input
            type="text"
            id="authorInput"
            placeholder="ç•™ç©ºè‡ªåŠ¨åŒ¿å"
            class="w-full px-3 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all shadow-sm"
          />
        </div>
        <!-- Emoji é€‰æ‹© -->
        <div class="w-full">
          <label class="block text-sm font-medium mb-1.5 text-gray-700">é€‰æ‹©è¡¨æƒ…</label>
          <div class="emoji-picker" id="emojiPicker"></div>
          <div id="emojiPreview" class="mt-2.5 flex flex-wrap gap-1.5"></div>
        </div>
      </div>

      <!-- è¡Œ2ï¼šæ ‡ç­¾é€‰æ‹© + è‡ªå®šä¹‰æ ‡ç­¾ -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-5">
        <!-- é¢„è®¾æ ‡ç­¾ -->
        <div>
          <label class="block text-sm font-medium mb-1.5 text-gray-700">é€‰æ‹©æ ‡ç­¾</label>
          <div class="tags-container flex flex-wrap gap-2">
            <div class="tag" data-tag="æ—¥å¸¸">æ—¥å¸¸</div>
            <div class="tag" data-tag="ç¾é£Ÿ">ç¾é£Ÿ</div>
            <div class="tag" data-tag="æ—…è¡Œ">æ—…è¡Œ</div>
            <div class="tag" data-tag="æ„Ÿæ‚Ÿ">æ„Ÿæ‚Ÿ</div>
            <div class="tag" data-tag="å…¶ä»–">å…¶ä»–</div>
          </div>
        </div>
        <!-- è‡ªå®šä¹‰æ ‡ç­¾ -->
        <div>
          <label class="block text-sm font-medium mb-1.5 text-gray-700">è‡ªå®šä¹‰æ ‡ç­¾</label>
          <div class="flex gap-2">
            <input
              type="text"
              id="customTagInput"
              placeholder="è¾“å…¥æ ‡ç­¾"
              class="flex-1 px-3 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all shadow-sm"
            />
            <button
              type="button"
              id="addCustomTag"
              class="px-4 py-2.5 bg-secondary text-white rounded-lg hover:bg-secondary/90 transition-all font-medium"
            >
              <i class="fas fa-plus mr-1"></i> æ·»åŠ 
            </button>
          </div>
        </div>
      </div>

      <!-- è¡Œ3ï¼šåœ°ç†ä½ç½® + å†…å®¹è¾“å…¥ -->
      <div class="mb-5">
        <label for="locationInput" class="block text-sm font-medium mb-1.5 text-gray-700">åœ°ç†ä½ç½®ï¼ˆå¯é€‰ï¼‰</label>
        <input
          type="text"
          id="locationInput"
          placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬å¸‚æœé˜³åŒº"
          class="w-full px-3 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all shadow-sm"
        />
      </div>
      <div class="mb-5">
        <label for="diaryInput" class="block text-sm font-medium mb-1.5 text-gray-700">ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆæœ‰è¶£çš„äº‹ï¼Ÿ</label>
        <textarea
          id="diaryInput"
          rows="5"
          class="w-full px-3 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary resize-y transition-all shadow-sm"
          placeholder="åˆ†äº«ä½ çš„æ•…äº‹..."
        ></textarea>
      </div>

      <!-- è¡Œ4ï¼šæ–‡ä»¶ä¸Šä¼  + æ“ä½œæŒ‰é’® -->
      <div class="flex flex-col md:flex-row items-center justify-between gap-4 pt-2 border-t border-gray-100">
        <!-- æ–‡ä»¶ä¸Šä¼  -->
        <div class="flex items-center gap-2">
          <label
            for="fileInput"
            class="px-4 py-2.5 bg-gray-50 text-gray-700 rounded-lg cursor-pointer hover:bg-gray-100 transition-all shadow-sm"
          >
            <i class="fas fa-upload mr-1"></i> ä¸Šä¼ æ–‡ä»¶
          </label>
          <input type="file" id="fileInput" class="hidden" accept="*" />
          <span class="text-sm text-gray-500 truncate max-w-xs" id="fileName">æœªé€‰æ‹©æ–‡ä»¶</span>
        </div>
        <!-- æ“ä½œæŒ‰é’® -->
        <div class="flex gap-3">
          <button
            type="button"
            id="cancelBtn"
            class="px-4 py-2.5 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all font-medium"
          >
            å–æ¶ˆ
          </button>
          <button
            type="button"
            id="submitBtn"
            class="px-4 py-2.5 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all font-medium"
          >
            <i class="fas fa-paper-plane mr-1"></i> å‘è¡¨
          </button>
        </div>
      </div>
    </form>

    <!-- åŠ¨æ€å†…å®¹åŒº -->
    <div id="diaryList" class="space-y-5 mb-8">
      <!-- ç©ºçŠ¶æ€ -->
      <div class="empty-state">
        <i class="far fa-calendar-alt text-4xl mb-4 text-gray-300"></i>
        <h3 class="text-lg font-medium mb-2">æš‚æ— è®°å½•</h3>
        <p class="text-sm">æˆä¸ºç¬¬ä¸€ä¸ªåˆ†äº«ç”Ÿæ´»è¶£äº‹çš„äººå§ï¼</p>
      </div>
    </div>

    <!-- åˆ†é¡µæ§ä»¶ -->
    <div id="pagination" class="flex items-center justify-center gap-2 mt-8 mb-4 hidden">
      <button id="prevPage" class="page-btn" disabled>
        <i class="fas fa-chevron-left"></i>
      </button>
      <div id="pageNumbers" class="flex items-center gap-1"></div>
      <button id="nextPage" class="page-btn" disabled>
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>
  </main>

  <!-- è¯„è®ºå¼¹çª— -->
  <div
    id="commentModal"
    class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden p-4 backdrop-blur-sm"
  >
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 max-h-[80vh] overflow-y-auto relative transform transition-all">
      <button
        id="closeModal"
        class="absolute top-4 right-4 text-gray-500 hover:text-red-500 transition-colors"
      >
        <i class="fas fa-times text-xl"></i>
      </button>
      <h3 class="text-xl font-semibold text-primary mb-4">è¯„è®º</h3>
      <!-- è¯„è®ºè¡¨å• -->
      <form class="mb-6">
        <input
          type="text"
          id="modalCommentAuthor"
          placeholder="æ˜µç§°ï¼ˆå¯é€‰ï¼Œç•™ç©ºè‡ªåŠ¨åŒ¿åï¼‰"
          class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary mb-3 shadow-sm"
        />
        <textarea
          id="modalCommentContent"
          rows="3"
          class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary mb-3 shadow-sm"
          placeholder="å†™ä¸‹ä½ çš„è¯„è®º..."
        ></textarea>
        <input type="hidden" id="currentCommentId" value="" />
        <button
          type="button"
          id="submitCommentBtn"
          class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all font-medium"
        >
          <i class="fas fa-paper-plane mr-1"></i> å‘è¡¨è¯„è®º
        </button>
      </form>
      <!-- è¯„è®ºåˆ—è¡¨ -->
      <div id="modalCommentsList" class="space-y-3"></div>
    </div>
  </div>

  <script>
    // å…¨å±€å˜é‡
    let diaryData = JSON.parse(localStorage.getItem('diaryData')) || [];
    let currentEditingId = null;
    let currentCommentId = null;
    let selectedEmojis = [];
    let selectedTags = [];
    let customTags = JSON.parse(localStorage.getItem('customTags')) || [];
    let currentPage = 1;
    const PAGE_SIZE = 5;
    let totalPages = 1;
    let currentFilterTag = 'all';
    let currentSearchKeyword = '';
    const PRESET_TAGS = ['æ—¥å¸¸', 'ç¾é£Ÿ', 'æ—…è¡Œ', 'æ„Ÿæ‚Ÿ', 'å…¶ä»–']; // é¢„è®¾æ ‡ç­¾

    // å¸¸ç”¨è¡¨æƒ…åˆ—è¡¨
    const COMMON_EMOJIS = [
      "ğŸ˜Š", "ğŸ˜‚", "ğŸ˜", "ğŸ‘", "â¤ï¸", "ğŸ‰", "ğŸ¤”", "ğŸ˜¢", "ğŸ˜¡", "ğŸ‘",
      "ğŸ™", "ğŸ˜‰", "ğŸ˜", "ğŸ¥³", "ğŸ¤©", "ğŸ˜‹", "ğŸ¤¤", "ğŸ˜±", "ğŸ˜´", "ğŸ˜Œ",
      "ğŸ™Œ", "ğŸ’¯", "ğŸ”¥", "âœ¨", "ğŸŒŸ", "ğŸŠ", "ğŸ", "ğŸˆ", "ğŸ•", "ğŸœ",
      "ğŸ£", "ğŸº", "â˜•", "ğŸ¬", "ğŸµ", "ğŸ“š", "ğŸ“¸", "ğŸš—", "âœˆï¸", "ğŸ–ï¸"
    ];

    // é¡µé¢åŠ è½½åˆå§‹åŒ–
    window.onload = () => {
      initEmojiPicker();
      initEventListeners();
      renderDiaryList();
      updatePagination();
    };

    // åˆå§‹åŒ–Emojié€‰æ‹©å™¨
    function initEmojiPicker() {
      const picker = document.getElementById("emojiPicker");
      COMMON_EMOJIS.forEach(emoji => {
        const div = document.createElement("div");
        div.className = "emoji-item";
        div.textContent = emoji;
        div.onclick = () => addEmoji(emoji);
        picker.appendChild(div);
      });
    }

    // æ·»åŠ Emoji
    function addEmoji(emoji) {
      if (!selectedEmojis.includes(emoji)) {
        selectedEmojis.push(emoji);
        renderSelectedEmojis();
      }
    }

    // æ¸²æŸ“å·²é€‰Emoji
    function renderSelectedEmojis() {
      const preview = document.getElementById("emojiPreview");
      preview.innerHTML = '';
      selectedEmojis.forEach((emoji, index) => {
        const div = document.createElement("div");
        div.className = "selected-emoji";
        div.innerHTML = `${emoji}<span class="remove-emoji" data-index="${index}">Ã—</span>`;
        preview.appendChild(div);
      });
      document.querySelectorAll('.remove-emoji').forEach(btn => {
        btn.onclick = (e) => {
          selectedEmojis.splice(parseInt(e.target.dataset.index), 1);
          renderSelectedEmojis();
        };
      });
    }

    // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
    function initEventListeners() {
      // æäº¤æ—¥è®°
      document.getElementById("submitBtn").onclick = addOrUpdateDiary;
      
      // å–æ¶ˆ
      document.getElementById("cancelBtn").onclick = resetForm;
      
      // æ–‡ä»¶ä¸Šä¼ 
      document.getElementById("fileInput").onchange = (e) => {
        document.getElementById("fileName").textContent = e.target.files[0]?.name || "æœªé€‰æ‹©æ–‡ä»¶";
      };
      
      // æ ‡ç­¾é€‰æ‹©
      document.querySelectorAll('.tag').forEach(tag => {
        tag.onclick = () => toggleTag(tag);
      });
      
      // æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾
      document.getElementById("addCustomTag").onclick = addCustomTag;
      
      // è¿‡æ»¤æ ‡ç­¾ç‚¹å‡»
      document.querySelectorAll('.filter-tag').forEach(tag => {
        tag.onclick = () => {
          document.querySelectorAll('.filter-tag').forEach(t => t.classList.remove('active'));
          tag.classList.add('active');
          currentFilterTag = tag.dataset.tag;
          currentPage = 1;
          renderDiaryList();
          updatePagination();
        };
      });
      
      // è¯„è®ºå¼¹çª—å…³é—­
      document.getElementById("closeModal").onclick = () => {
        document.getElementById("commentModal").classList.add('hidden');
        resetCommentForm();
      };
      
      // æäº¤è¯„è®º
      document.getElementById("submitCommentBtn").onclick = submitComment;
      
      // æœç´¢æŒ‰é’®
      document.getElementById("searchBtn").onclick = triggerSearch;
      
      // ç§»åŠ¨ç«¯èœå•åˆ‡æ¢
      document.getElementById("mobileMenuBtn").onclick = () => {
        document.getElementById("mobileMenu").classList.toggle('hidden');
      };
      
      // åˆ†é¡µæŒ‰é’®äº‹ä»¶
      document.getElementById("prevPage").onclick = () => {
        if (currentPage > 1) {
          currentPage--;
          renderDiaryList();
          updatePagination();
          scrollToTop();
        }
      };
      
      document.getElementById("nextPage").onclick = () => {
        if (currentPage < totalPages) {
          currentPage++;
          renderDiaryList();
          updatePagination();
          scrollToTop();
        }
      };
    }

    // è§¦å‘æœç´¢
    function triggerSearch() {
      currentSearchKeyword = document.getElementById("searchInput").value.toLowerCase();
      currentPage = 1;
      renderDiaryList();
      updatePagination();
    }

    // åˆ‡æ¢æ ‡ç­¾é€‰æ‹©
    function toggleTag(tagElement) {
      const tag = tagElement.dataset.tag;
      const index = selectedTags.indexOf(tag);
      
      if (index === -1) {
        selectedTags.push(tag);
        tagElement.classList.add('active');
      } else {
        selectedTags.splice(index, 1);
        tagElement.classList.remove('active');
      }
    }

    // æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾
    function addCustomTag() {
      const input = document.getElementById("customTagInput");
      const tag = input.value.trim();
      
      if (tag && !selectedTags.includes(tag) && !COMMON_EMOJIS.includes(tag)) {
        selectedTags.push(tag);
        customTags.push(tag);
        localStorage.setItem('customTags', JSON.stringify(customTags));
        
        // æ·»åŠ åˆ°æ ‡ç­¾å®¹å™¨
        const container = document.querySelector('.tags-container');
        const div = document.createElement("div");
        div.className = "tag active";
        div.dataset.tag = tag;
        div.textContent = tag;
        div.onclick = () => toggleTag(div);
        container.appendChild(div);
        input.value = '';
      }
    }

    // æäº¤/æ›´æ–°æ—¥è®°
    function addOrUpdateDiary() {
      const author = document.getElementById("authorInput").value.trim() || 'åŒ¿åç”¨æˆ·';
      const content = document.getElementById("diaryInput").value.trim();
      const location = document.getElementById("locationInput").value.trim();
      const fileInput = document.getElementById("fileInput");
      let fileInfo = null;

      if (!content) return alert('è¯·åˆ†äº«ä½ çš„æ•…äº‹');
      if (!selectedTags.length) return alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ ‡ç­¾');

      // å¤„ç†æ–‡ä»¶
      if (fileInput.files[0]) {
        const file = fileInput.files[0];
        fileInfo = {
          name: file.name,
          url: URL.createObjectURL(file),
          type: file.type.split('/')[0]
        };
      }

      if (currentEditingId) {
        // æ›´æ–°ç°æœ‰æ—¥è®°
        const index = diaryData.findIndex(item => item.id === currentEditingId);
        diaryData[index] = {
          ...diaryData[index],
          author,
          content,
          location,
          fileInfo,
          emojis: selectedEmojis,
          tags: selectedTags,
          updateTime: new Date().toISOString()
        };
      } else {
        // æ·»åŠ æ–°æ—¥è®°
        diaryData.unshift({
          id: Date.now().toString(),
          author,
          content,
          location,
          fileInfo,
          emojis: selectedEmojis,
          tags: selectedTags,
          createTime: new Date().toISOString(),
          comments: []
        });
      }

      // ä¿å­˜è‡ªå®šä¹‰æ ‡ç­¾
      const newCustomTags = selectedTags.filter(tag => !PRESET_TAGS.includes(tag));
      customTags = [...new Set([...customTags, ...newCustomTags])];
      localStorage.setItem('customTags', JSON.stringify(customTags));

      // ä¿å­˜å¹¶åˆ·æ–°
      saveDiaryData();
      renderDiaryList();
      updatePagination();
      resetForm();
    }

    // é‡ç½®è¡¨å•
    function resetForm() {
      document.getElementById("authorInput").value = '';
      document.getElementById("diaryInput").value = '';
      document.getElementById("locationInput").value = '';
      document.getElementById("fileInput").value = '';
      document.getElementById("fileName").textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
      selectedEmojis = [];
      selectedTags = [];
      renderSelectedEmojis();
      document.querySelectorAll('.tag.active').forEach(tag => {
        tag.classList.remove('active');
      });
      currentEditingId = null;
    }

    // é‡ç½®è¯„è®ºè¡¨å•
    function resetCommentForm() {
      document.getElementById("modalCommentAuthor").value = '';
      document.getElementById("modalCommentContent").value = '';
      document.getElementById("currentCommentId").value = '';
      currentCommentId = null;
    }

    // æäº¤è¯„è®º
    function submitComment() {
      const postId = document.getElementById("commentModal").dataset.postId;
      const author = document.getElementById("modalCommentAuthor").value.trim() || 'åŒ¿åç”¨æˆ·';
      const content = document.getElementById("modalCommentContent").value.trim();
      const commentId = document.getElementById("currentCommentId").value;
      
      if (!content) return alert('è¯·å¡«å†™è¯„è®ºå†…å®¹');

      const postIndex = diaryData.findIndex(item => item.id === postId);
      if (postIndex === -1) return;

      if (commentId) {
        // ç¼–è¾‘ç°æœ‰è¯„è®º
        const commentIndex = diaryData[postIndex].comments.findIndex(c => c.id === commentId);
        if (commentIndex !== -1) {
          diaryData[postIndex].comments[commentIndex] = {
            ...diaryData[postIndex].comments[commentIndex],
            author,
            content,
            time: new Date().toISOString()
          };
        }
      } else {
        // æ·»åŠ æ–°è¯„è®º
        diaryData[postIndex].comments.push({
          id: Date.now().toString(),
          author,
          content,
          time: new Date().toISOString()
        });
      }

      saveDiaryData();
      renderComments(postId);
      renderDiaryList();
      resetCommentForm();
    }

    // ç¼–è¾‘è¯„è®º
    function editComment(postId, commentId) {
      const postIndex = diaryData.findIndex(item => item.id === postId);
      if (postIndex === -1) return;
      
      const comment = diaryData[postIndex].comments.find(c => c.id === commentId);
      if (!comment) return;

      document.getElementById("modalCommentAuthor").value = comment.author;
      document.getElementById("modalCommentContent").value = comment.content;
      document.getElementById("currentCommentId").value = commentId;
      currentCommentId = commentId;
    }

    // åˆ é™¤è¯„è®º
    function deleteComment(postId, commentId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ')) return;

      const postIndex = diaryData.findIndex(item => item.id === postId);
      if (postIndex === -1) return;

      diaryData[postIndex].comments = diaryData[postIndex].comments.filter(
        c => c.id !== commentId
      );

      saveDiaryData();
      renderComments(postId);
      renderDiaryList();
      resetCommentForm();
    }

    // æ¸²æŸ“è¯„è®º
    function renderComments(postId) {
      const post = diaryData.find(item => item.id === postId);
      const container = document.getElementById("modalCommentsList");
      container.innerHTML = '';
      
      if (!post?.comments?.length) {
        container.innerHTML = '<p class="text-center text-gray-500 text-sm py-3">æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘ï½</p>';
        return;
      }

      post.comments.forEach(comment => {
        const div = document.createElement("div");
        div.className = "p-3 bg-gray-50 rounded-lg";
        div.innerHTML = `
          <div class="flex justify-between items-start mb-1">
            <span class="font-medium text-primary">${comment.author}</span>
            <span class="text-xs text-gray-500">${formatTime(comment.time)}</span>
          </div>
          <p class="text-sm">${comment.content}</p>
          <div class="comment-actions">
            <button onclick="editComment('${postId}', '${comment.id}')">
              <i class="fas fa-edit text-xs mr-1"></i>ç¼–è¾‘
            </button>
            <button onclick="deleteComment('${postId}', '${comment.id}')">
              <i class="fas fa-trash text-xs mr-1"></i>åˆ é™¤
            </button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    // æ¸²æŸ“æ—¥è®°åˆ—è¡¨ï¼ˆå¸¦åˆ†é¡µï¼‰
    function renderDiaryList() {
      const container = document.getElementById("diaryList");
      let filteredData = [...diaryData];

      // æ ‡ç­¾è¿‡æ»¤ï¼ˆå«è‡ªå®šä¹‰æ ‡ç­¾ç­›é€‰é€»è¾‘ï¼‰
      if (currentFilterTag !== 'all') {
        if (currentFilterTag === 'custom') {
          // ç­›é€‰åŒ…å«è‡ªå®šä¹‰æ ‡ç­¾çš„å†…å®¹ï¼ˆéé¢„è®¾æ ‡ç­¾ï¼‰
          filteredData = filteredData.filter(item => 
            item.tags.some(tag => !PRESET_TAGS.includes(tag))
          );
        } else {
          // å¸¸è§„æ ‡ç­¾ç­›é€‰
          filteredData = filteredData.filter(item => 
            item.tags.includes(currentFilterTag)
          );
        }
      }

      // æœç´¢è¿‡æ»¤
      if (currentSearchKeyword) {
        filteredData = filteredData.filter(item => 
          item.author.toLowerCase().includes(currentSearchKeyword) || 
          item.content.toLowerCase().includes(currentSearchKeyword) ||
          item.tags.some(tag => tag.toLowerCase().includes(currentSearchKeyword))
        );
      }

      // åˆ†é¡µå¤„ç†
      totalPages = Math.max(1, Math.ceil(filteredData.length / PAGE_SIZE));
      const startIndex = (currentPage - 1) * PAGE_SIZE;
      const paginatedData = filteredData.slice(startIndex, startIndex + PAGE_SIZE);

      // ç©ºçŠ¶æ€å¤„ç†
      if (paginatedData.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="far fa-calendar-alt text-4xl mb-4 text-gray-300"></i>
            <h3 class="text-lg font-medium mb-2">æš‚æ— è®°å½•</h3>
            <p class="text-sm">${currentFilterTag !== 'all' ? 'è¯¥æ ‡ç­¾ä¸‹æš‚æ— å†…å®¹' : 'æˆä¸ºç¬¬ä¸€ä¸ªåˆ†äº«çš„äººå§'}</p>
          </div>
        `;
        document.getElementById("pagination").classList.add('hidden');
        return;
      }

      // æ˜¾ç¤ºåˆ†é¡µæ§ä»¶
      document.getElementById("pagination").classList.remove('hidden');

      // æ¸²æŸ“æ—¥è®°å¡ç‰‡
      container.innerHTML = '';
      paginatedData.forEach(item => {
        const card = document.createElement("div");
        card.className = "diary-card";
        
        // æ–‡ä»¶é¢„è§ˆå†…å®¹
        let filePreview = '';
        if (item.fileInfo) {
          if (item.fileInfo.type === 'image') {
            filePreview = `
              <div class="mb-3 rounded-lg overflow-hidden">
                <img src="${item.fileInfo.url}" alt="${item.fileInfo.name}" class="w-full h-48 object-cover transition-transform duration-500 hover:scale-105">
                <p class="text-xs text-gray-500 mt-1">${item.fileInfo.name}</p>
              </div>
            `;
          } else {
            filePreview = `
              <div class="file-preview">
                <div class="file-icon">
                  <i class="fas fa-file-${item.fileInfo.type === 'pdf' ? 'pdf' : 'alt'}"></i>
                </div>
                <div class="flex-1">
                  <p class="text-sm truncate">${item.fileInfo.name}</p>
                  <a href="${item.fileInfo.url}" target="_blank" class="text-xs text-primary hover:underline">ä¸‹è½½æ–‡ä»¶</a>
                </div>
              </div>
            `;
          }
        }

        card.innerHTML = `
          <div class="flex justify-between items-start mb-3">
            <div class="flex items-center gap-2">
              <span class="font-medium text-primary">${item.author}</span>
              <div class="flex gap-1">${item.emojis.join('')}</div>
            </div>
            <span class="text-xs text-gray-500">${formatTime(item.createTime)}</span>
          </div>
          
          ${item.location ? `<div class="text-sm text-gray-600 mb-3 flex items-center">
            <i class="fas fa-map-marker-alt text-gray-400 mr-1"></i> ${item.location}
          </div>` : ''}
          
          <p class="text-gray-800 mb-3 text-balance">${item.content}</p>
          
          ${filePreview}
          
          <div class="flex flex-wrap gap-2 mb-3">
            ${item.tags.map(tag => `<span class="text-xs bg-primary/10 text-primary px-2 py-0.5 rounded-full">${tag}</span>`).join('')}
          </div>
          
          <div class="flex gap-4 text-sm text-gray-500">
            <button class="flex items-center gap-1 hover:text-primary transition-colors" onclick="openCommentModal('${item.id}')">
              <i class="fas fa-comment"></i> è¯„è®º(${item.comments?.length || 0})
            </button>
            <button class="flex items-center gap-1 hover:text-primary transition-colors" onclick="editDiary('${item.id}')">
              <i class="fas fa-edit"></i> ç¼–è¾‘
            </button>
            <button class="flex items-center gap-1 hover:text-red-500 transition-colors" onclick="deleteDiary('${item.id}')">
              <i class="fas fa-trash"></i> åˆ é™¤
            </button>
          </div>
        `;
        container.appendChild(card);
      });
    }

    // æ›´æ–°åˆ†é¡µæŒ‰é’® - ä¼˜åŒ–ç‰ˆ
function updatePagination() {
  const totalPages = Math.ceil(filteredCards.length / itemsPerPage);
  const paginationContainer = document.getElementById('pagination');
  
  // æ¸…ç©ºç°æœ‰é¡µç æŒ‰é’®ï¼ˆä¿ç•™å‰åæŒ‰é’®ï¼‰
  const pageButtons = paginationContainer.querySelectorAll('.pagination-btn:not([data-page="prev"]):not([data-page="next"])');
  pageButtons.forEach(btn => btn.remove());
  
  // æ·»åŠ é¡µç æŒ‰é’®ï¼ˆåªåœ¨æœ‰æ•°æ®æ—¶æ·»åŠ ï¼‰
  if (totalPages > 0) {
    const prevButton = paginationContainer.querySelector('[data-page="prev"]');
    for (let i = 1; i <= totalPages; i++) {
      const button = document.createElement('button');
      button.className = `pagination-btn px-4 py-2 rounded-lg border border-gray-300 transition-colors ${i === currentPage ? 'bg-primary text-white' : 'hover:bg-gray-100'}`;
      button.setAttribute('data-page', i);
      button.textContent = i;
      
      button.addEventListener('click', function() {
        const page = parseInt(this.getAttribute('data-page'));
        renderPage(page);
      });
      
      prevButton.after(button);
    }
  }
  
  // ç¦ç”¨/å¯ç”¨å‰åæŒ‰é’®
  const prevBtn = paginationContainer.querySelector('[data-page="prev"]');
  const nextBtn = paginationContainer.querySelector('[data-page="next"]');
  
  prevBtn.disabled = currentPage === 1 || totalPages === 0;
  prevBtn.classList.toggle('opacity-50', currentPage === 1 || totalPages === 0);
  prevBtn.classList.toggle('cursor-not-allowed', currentPage === 1 || totalPages === 0);
  
  nextBtn.disabled = currentPage === totalPages || totalPages === 0;
  nextBtn.classList.toggle('opacity-50', currentPage === totalPages || totalPages === 0);
  nextBtn.classList.toggle('cursor-not-allowed', currentPage === totalPages || totalPages === 0);
  
  // æ˜¾ç¤º/éšè—ç©ºçŠ¶æ€å’Œåˆ†é¡µæ§ä»¶
  const emptyState = document.getElementById('empty-state');
  if (filteredCards.length === 0) {
    emptyState.classList.remove('hidden');
    paginationContainer.classList.add('hidden');
  } else {
    emptyState.classList.add('hidden');
    paginationContainer.classList.remove('hidden');
  }
}

    // æ»šåŠ¨åˆ°é¡¶éƒ¨
    function scrollToTop() {
      window.scrollTo({
        top: document.getElementById("diaryList").offsetTop - 20,
        behavior: 'smooth'
      });
    }

    // æ‰“å¼€è¯„è®ºå¼¹çª—
    function openCommentModal(postId) {
      const modal = document.getElementById("commentModal");
      modal.dataset.postId = postId;
      renderComments(postId);
      modal.classList.remove('hidden');
      resetCommentForm();
    }

    // ç¼–è¾‘æ—¥è®°
    function editDiary(id) {
      const item = diaryData.find(item => item.id === id);
      if (!item) return;
      
      currentEditingId = id;
      document.getElementById("authorInput").value = item.author;
      document.getElementById("diaryInput").value = item.content;
      document.getElementById("locationInput").value = item.location || '';
      selectedEmojis = [...item.emojis];
      selectedTags = [...item.tags];
      
      renderSelectedEmojis();
      
      // æ¿€æ´»æ ‡ç­¾
      document.querySelectorAll('.tag').forEach(tag => {
        if (selectedTags.includes(tag.dataset.tag)) {
          tag.classList.add('active');
        } else {
          tag.classList.remove('active');
        }
      });

      document.querySelector('form').scrollIntoView({ behavior: 'smooth' });
    }

    // åˆ é™¤æ—¥è®°
    function deleteDiary(id) {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
        diaryData = diaryData.filter(item => item.id !== id);
        saveDiaryData();
        renderDiaryList();
        updatePagination();
      }
    }

    // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
    function saveDiaryData() {
      localStorage.setItem('diaryData', JSON.stringify(diaryData));
    }

    // æ ¼å¼åŒ–æ—¶é—´
    function formatTime(isoTime) {
      const date = new Date(isoTime);
      return date.toLocaleString('zh-CN', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
  </script>
</body>
</html>